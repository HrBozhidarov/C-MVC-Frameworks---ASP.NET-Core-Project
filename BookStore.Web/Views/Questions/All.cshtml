@model VizualizeContactModel[]

@{
    ViewData["Title"] = "All Questions";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="text-center my-3">@ViewData["Title"]</h2>
<div class="container w-75" style="min-height:320px;">
    <table id="notAll" class="table table-hover">
        <thead>
            <tr class="row">
                <th class="col-lg-2 col d-flex justify-content-center" scope="col">#</th>
                <th class="col-lg-3 col d-flex justify-content-center" scope="col">Title</th>
                <th class="col-lg-3 col d-flex justify-content-center" scope="col">View</th>
                <th class="col-lg-3 col d-flex justify-content-center" scope="col">Delete</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Length; i++)
            {
                var count = i + 1;
                var question = Model[i];

                <tr class="row">
                    <th class="col-lg-2 col d-flex justify-content-center" scope="row">@count</th>
                    <td class="col-lg-3 col d-flex justify-content-center">@question.Title</td>

                    @if (question.IsSeen)
                    {
                        <td class="col-lg-3 col d-flex justify-content-center"><button class="btn btn-success click">Notification</button><div hidden>@question.Id</div></td>
                    }
                    else
                    {
                        <td class="col-lg-3 col d-flex justify-content-center"><button class="btn btn-warning click">Notification</button><div hidden>@question.Id</div></td>
                    }
                    <td class="col-lg-3 col d-flex justify-content-center"><button class="btn btn-danger del">Delete</button><div hidden>@question.Id</div></td>
                </tr>
            }
        </tbody>
    </table>
</div>

@(Html.Kendo().Window()
                              .Name("windowSend")
                              .MinWidth(450)
                              .Height(450)
                              .Visible(false)
                              .Title("Send Email on user!")
                              .Content(@<text>
                                <div id="sednEmail" style="width:100%"></div>
                            </text>).Events(ev => ev.Close("onClose"))
)

<script>

    $('.del').click(function () {
        $(this).parent().parent().hide();
        let id = $(this).next().text();
        var deleUrl = `/api/ApiQuestions/deleteQuestion/${id}`;

        $.ajax({
            url: deleUrl,
            data: { },
            type: 'DELETE',
            contentType: "aplication/json",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("XSRF-TOKEN", $('input:hidden[name="__RequestVerificationToken"]').val());
            },
            success: function (data) {
                var number = parseInt($("#requestNotification").text());
                if (number > 0) {
                    number--;
                    $("#requestNotification").html(number);
                }
            },
            error: function () {
                alert('Error occurred in VISUALIZE CREATE');
            }
        });
    })

    function onClose() {
        $("#sednEmail").show();
    }

    $(document).ready(function () {
        $(".click").bind("click", function () {
            $("#windowSend").data("kendoWindow").open().center();

            let visualizeOfSendEmail = "/Questions/VisualizeSendEmail";

            let id = parseInt($(this).next().text());
            $(this).removeClass("btn-warning").addClass("btn-success")

            var number = parseInt($("#requestNotification").text());
            if (number > 0) {
                number--;
                $("#requestNotification").html(number);
            }

            $.ajax({
                url: visualizeOfSendEmail,
                data: { id: id },
                type: 'POST',
                dataType: 'html',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN", $('input:hidden[name="__RequestVerificationToken"]').val());
                },
                success: function (data) {
                    if (data != null) {
                        $("#sednEmail").html(data);
                    }
                },
                error: function () {
                    alert('Error occurred in VISUALIZE CREATE');
                }
            }).then(function () {
                var putUrl = `/api/ApiQuestions/updateState/${id}`;

                $.ajax({
                    url: putUrl,
                    data: {},
                    type: 'PUT',
                    contentType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN", $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                    success: function (data) {

                    },
                    error: function (data) {
                        console.log(data);
                    }
                })
            })
        });
    });
</script>

